<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>MS-DOS</title>
<style>
* {
  user-select: none;
  -webkit-user-select: none;
  -ms-user-select: none;
}
body {
  margin: 0;
  background: black;
  color: #ffffff;
  font-family: "Courier New", monospace;
  font-size: 16px;
}
#screen {
  padding: 10px;
  white-space: pre-wrap;
  outline: none;
}
.bsod {
  background: #0000aa;
  color: white;
  padding: 12px;
}
.hidden { display: none; }
</style>
</head>

<body tabindex="0">
<div id="screen"></div>

<script>
/* ===================== IMMERSION LOCK ===================== */

document.addEventListener("contextmenu", e => e.preventDefault());
document.body.focus();
document.body.addEventListener("blur",()=>document.body.focus());

/* ===================== CORE STATE ===================== */

const screen = document.getElementById("screen");
let HALTED=false, INPUT="", READY=false;

const CPU={
 AX:0,BX:0,CX:0,DX:0,SI:0,DI:0,BP:0,SP:0,
 CS:0x1000,IP:0x0000,DS:0x2000,ES:0x2000,SS:0x3000,
 FLAGS:0,MODE:"real",PAGING:false,V86:false
};

const PORTS={}, TSR=[];

/* ===================== FILE SYSTEM ===================== */

const FS={
 "C:":{type:"dir",children:{
  "CONFIG.SYS":{type:"file",content:"DEVICE=HIMEM.SYS\nDOS=HIGH"},
  "AUTOEXEC.BAT":{type:"file",content:"ECHO Booting MS-DOS...\nTSR CLOCK\nCLS"},
  "COMMAND.COM":{type:"file",content:""}
 }}
};
let cwd=["C:"];

function getDir(p=cwd){
 let n=FS; for(const x of p) n=n[x].children; return n;
}

/* ===================== OUTPUT ===================== */

function out(t=""){
 if(HALTED) return;
 screen.innerHTML+=t+"\n";
 scroll();
}
function scroll(){ window.scrollTo(0,document.body.scrollHeight); }
function hex(v){return "0x"+v.toString(16).toUpperCase();}

/* ===================== POST / BIOS ===================== */

function POST(){
 screen.innerHTML="";
 const lines=[
  "PhoenixBIOS 4.0 Release 6.0",
  "Copyright 1985-1998 Phoenix Technologies Ltd.",
  "",
  "CPU = Intel(R) 80486DX",
  "Checking RAM: 640K OK",
  "Detecting IDE Drives ... OK",
  "Keyboard detected",
  "",
  "Press DEL to enter SETUP",
  ""
 ];
 let i=0;
 const timer=setInterval(()=>{
  out(lines[i++]||"");
  if(i>=lines.length){ clearInterval(timer); setTimeout(bootDOS,1200); }
 },350);
}

/* ===================== BOOT ===================== */

function bootDOS(){
 screen.innerHTML="";
 out("Starting MS-DOS...");
 parseConfig();
 runAutoexec();
 prompt();
 READY=true;
}

/* ===================== CONFIG / AUTOEXEC ===================== */

function parseConfig(){
 const cfg=FS["C:"].children["CONFIG.SYS"].content.split("\n");
 for(const l of cfg){
  if(l.startsWith("DEVICE=")) out("Loading "+l.split("=")[1]);
  if(l==="DOS=HIGH"){ CPU.MODE="protected"; CPU.PAGING=true; }
 }
}

function runAutoexec(){
 const bat=FS["C:"].children["AUTOEXEC.BAT"].content.split("\n");
 for(const c of bat) exec(c);
}

/* ===================== TSR ===================== */

function loadTSR(n){
 if(n==="CLOCK"){
  TSR.unshift(i=>{
   if(i===0x1C) out("[CLOCK] "+new Date().toLocaleTimeString());
  });
  out("Resident CLOCK loaded");
 }
}

/* ===================== COMMAND EXEC ===================== */

function exec(line){
 const a=line.trim().split(/\s+/);
 const c=a[0]?.toUpperCase();
 const dir=getDir();

 switch(c){
  case "DIR":
   out(" Directory of "+cwd.join("\\"));
   for(const k in dir)
    out((dir[k].type==="dir"?"<DIR> ":"      ")+k);
   break;

  case "CD":
   if(a[1]===".."){ if(cwd.length>1) cwd.pop(); }
   else if(dir[a[1]]?.type==="dir") cwd.push(a[1]);
   else out("Path not found");
   break;

  case "TYPE":
   dir[a[1]]?.type==="file"
    ? out(dir[a[1]].content)
    : out("File not found");
   break;

  case "DEL":
   dir[a[1]] ? delete dir[a[1]] : out("File not found");
   break;

  case "COPY":
   if(dir[a[1]]?.type==="file"){
    dir[a[2]]={type:"file",content:dir[a[1]].content};
    out("1 file(s) copied.");
   } else out("File not found");
   break;

  case "MKDIR": dir[a[1]]={type:"dir",children:{}}; break;
  case "RMDIR": dir[a[1]]?.type==="dir" ? delete dir[a[1]] : out("Directory not found"); break;
  case "ECHO": out(a.slice(1).join(" ")); break;
  case "CLS": screen.innerHTML=""; break;
  case "TSR": loadTSR(a[1]); break;
  case "CRASH": crash("Manual crash"); return;

  default: out("Bad command or file name");
 }
 prompt();
}

/* ===================== PROMPT / INPUT ===================== */

function prompt(){
 out(cwd.join("\\")+">"+INPUT);
}

document.addEventListener("keydown",e=>{
 if(!READY||HALTED) return;
 if(e.key==="Backspace"){
  INPUT=INPUT.slice(0,-1);
  screen.innerHTML=screen.innerHTML.slice(0,-1);
 }
 else if(e.key==="Enter"){
  out("");
  exec(INPUT);
  INPUT="";
 }
 else if(e.key.length===1){
  INPUT+=e.key;
  screen.innerHTML+=e.key;
 }
});

/* ===================== BSOD ===================== */

function crash(reason){
 HALTED=true;
 screen.innerHTML=
`<div class="bsod">
A problem has been detected and DOS has been shut down.

${reason}

CS:${hex(CPU.CS)} IP:${hex(CPU.IP)}
DS:${hex(CPU.DS)} ES:${hex(CPU.ES)}

Press Reset to restart your computer.
</div>`;
}

/* ===================== TIMER ===================== */

setInterval(()=>TSR.forEach(t=>t(0x1C)),3000);

/* ===================== START ===================== */

POST();
</script>
</body>
</html>
