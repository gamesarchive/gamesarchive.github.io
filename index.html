<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>MS-DOS</title>
<style>
*{user-select:none}
body{
  margin:0;
  background:black;
  color:white;
  font-family:"Courier New",monospace;
  font-size:16px;
}
#screen{
  padding:10px;
  white-space:pre-wrap;
}
.bsod{
  background:#0000aa;
  color:white;
  padding:12px;
}
</style>
</head>

<body tabindex="0">
<div id="screen"></div>

<script>
/* ================= IMMERSION ================= */
document.body.focus();
document.addEventListener("contextmenu",e=>e.preventDefault());
document.body.addEventListener("blur",()=>document.body.focus());

/* ================= CORE STATE ================= */
const screen=document.getElementById("screen");
let INPUT="", READY=false, HALTED=false;
let BASIC_MODE=false;
let cwd=["C:"];

/* ================= CPU / MEMORY ================= */
const CPU={ MODE:"real" };

/* ================= FILE SYSTEM ================= */
const FS={
 "C:":{type:"dir",children:{
  "CONFIG.SYS":{type:"file",content:"DOS=HIGH"},
  "AUTOEXEC.BAT":{type:"file",content:"ECHO Booting MS-DOS...\nCLS"},
  "COMMAND.COM":{type:"file",content:""}
 }},
 "A:":{type:"dir",volume:"FLOPPY",serial:0x1A2B,children:{
  "HELLO.TXT":{type:"file",content:"Hello from floppy disk."},
  "README.TXT":{type:"file",content:"Use DIR to list files."}
 }},
 "B:":{type:"dir",volume:"FLOPPY2",serial:0x2B3C,children:{}}
};

function getDir(){ 
 let n=FS;
 for(const p of cwd) n=n[p].children;
 return n;
}

/* ================= OUTPUT ================= */
function clear(){ screen.innerHTML=""; }
function write(t){ screen.innerHTML+=t; scroll(); }
function writeln(t=""){ write(t+"\n"); }
function scroll(){ window.scrollTo(0,document.body.scrollHeight); }

/* ================= PC SPEAKER ================= */
function beep(){
 try{
  const ctx=new AudioContext();
  const osc=ctx.createOscillator();
  osc.type="square";
  osc.frequency.value=880;
  osc.connect(ctx.destination);
  osc.start();
  osc.stop(ctx.currentTime+0.08);
 }catch{}
}

/* ================= POST ================= */
async function POST(){
 clear();
 writeln("PhoenixBIOS 4.0 Release 6.0");
 writeln("Copyright 1985-1998 Phoenix Technologies Ltd.");
 writeln("");
 await delay(400);

 writeln("CPU = Intel(R) 80486DX");
 await delay(300);

 for(let m=0;m<=640;m+=128){
  write(`Checking RAM: ${m}K\r`);
  await delay(120);
 }
 writeln("Checking RAM: 640K OK");

 writeln("Detecting IDE Primary Master ... OK");
 writeln("Detecting Floppy Drive A: ... OK");
 await delay(400);

 beep();
 await delay(600);

 // Critical file check
 if(!FS["C:"].children["COMMAND.COM"]){
  writeln("\nCritical system file COMMAND.COM missing!");
  writeln("System halted.");
  HALTED=true;
  return;
 }

 bootDOS();
}

/* ================= BOOT ================= */
function bootDOS(){
 clear();
 writeln("Starting MS-DOS...");
 writeln("");
 writeln("Command v4.00");
 writeln("Copyright (C) 1981-1985 Microsoft Corp.");
 writeln("");
 READY=true;
 prompt();
}

/* ================= PROMPT ================= */
function prompt(){
 write(cwd.join("\\")+">"+INPUT);
}

/* ================= COMMAND EXEC ================= */
function exec(cmd){
 const a=cmd.trim().split(/\s+/);
 const c=a[0]?.toUpperCase();
 const dir=getDir();

 if(BASIC_MODE){
  if(c==="EXIT"){ BASIC_MODE=false; writeln("\nOk"); }
  else writeln("Syntax error");
  return;
 }

 switch(c){

  case "HELP":
   writeln("For more information on a specific command, type HELP command-name");
   writeln("DIR CD TREE COPY DEL TYPE CLS VER DATE TIME");
   writeln("APPEND ASSIGN ATTRIB BACKUP RESTORE BASIC");
   writeln("FORMAT VOL CHKDSK DISKCOPY REBOOT SHUTDOWN");
   break;

  case "CLS": clear(); break;

  case "VER": writeln("MS-DOS Version 4.00"); break;

  case "DIR":
   {
    let drive=cwd[0]; if(a[1]) drive=a[1].toUpperCase();
    if(!FS[drive]){ writeln("Drive not found"); break; }
    const d=FS[drive].children;
    writeln(` Volume in drive ${drive} is ${FS[drive].volume||"NO NAME"}`);
    writeln(" Directory of "+drive);
    for(const f in d){
     const info=d[f];
     writeln((info.type==="dir"? "<DIR> ":"      ")+f);
    }
   }
   break;

  case "VOL":
   {
    let drive=cwd[0]; if(a[1]) drive=a[1].toUpperCase();
    if(!FS[drive]){ writeln("Drive not found"); break; }
    writeln(` Volume in drive ${drive} is ${FS[drive].volume||"NO NAME"}`);
    writeln(` Volume Serial Number is ${FS[drive].serial.toString(16).toUpperCase()}`);
   }
   break;

  case "FORMAT":
   {
    let drive=cwd[0]; if(a[1]) drive=a[1].toUpperCase();
    if(!FS[drive]){ writeln("Drive not found"); break; }
    writeln(`Insert new diskette in drive ${drive} and press ENTER`);
    HALTED=true;
    document.onkeydown=e=>{
      if(e.key==="Enter"){
        FS[drive].children={};
        FS[drive].volume="NEWVOL";
        FS[drive].serial=Math.floor(Math.random()*0xFFFF);
        HALTED=false;
        writeln(`Drive ${drive} formatted.`);
        prompt();
      }
    };
   }
   break;

  case "CHKDSK":
   {
    let drive=cwd[0]; if(a[1]) drive=a[1].toUpperCase();
    if(!FS[drive]){ writeln("Drive not found"); break; }
    writeln(`Checking disk ${drive}...`);
    writeln("0 bytes in bad sectors");
   }
   break;

  case "DISKCOPY":
   {
    let src=a[1]?.toUpperCase(); let dest=a[2]?.toUpperCase();
    if(!FS[src]||!FS[dest]){ writeln("Drive not found"); break; }
    FS[dest].children=JSON.parse(JSON.stringify(FS[src].children));
    FS[dest].volume=FS[src].volume;
    FS[dest].serial=FS[src].serial;
    writeln(`Copy complete from ${src} to ${dest}`);
   }
   break;

  case "CD":
  case "CHDIR":
   if(a[1]===".."){ if(cwd.length>1) cwd.pop(); }
   else if(dir[a[1]]?.type==="dir") cwd.push(a[1]);
   else writeln("Invalid directory");
   break;

  case "TREE":
   function tree(d,p=""){
    for(const k in d){
     writeln(p+k);
     if(d[k].type==="dir") tree(d[k].children,p+"â”‚  ");
    }
   }
   tree(dir);
   break;

  case "TYPE":
   dir[a[1]]?.type==="file"
    ? writeln(dir[a[1]].content)
    : writeln("File not found");
   break;

  case "DEL":
   dir[a[1]] ? delete dir[a[1]] : writeln("File not found");
   break;

  case "COPY":
   if(dir[a[1]]?.type==="file"){
    dir[a[2]]={type:"file",content:dir[a[1]].content};
    writeln("        1 file(s) copied.");
   }else writeln("File not found");
   break;

  case "ATTRIB":
   writeln("A    "+(a[1]||""));
   break;

  case "BACKUP":
  case "RESTORE":
   writeln("Insert diskette and press any key...");
   break;

  case "APPEND":
  case "ASSIGN":
  case "ATMDM":
   writeln("Command completed.");
   break;

  case "BASIC":
   BASIC_MODE=true;
   writeln("Microsoft BASIC Version 1.10");
   writeln("Ok");
   break;

  case "DATE":
   writeln(new Date().toLocaleDateString());
   break;

  case "TIME":
   writeln(new Date().toLocaleTimeString());
   break;

  case "REBOOT":
   READY=false; HALTED=false; INPUT=""; POST(); return;

  case "SHUTDOWN":
   clear(); writeln("It is now safe to turn off your computer."); HALTED=true; break;

  default:
   writeln("Bad command or file name");
 }
}

/* ================= INPUT HANDLING ================= */
document.addEventListener("keydown",e=>{
 if(!READY||HALTED) return;

 if(e.key==="Backspace"){
  INPUT=INPUT.slice(0,-1);
  screen.innerHTML=screen.innerHTML.slice(0,-1);
 }
 else if(e.key==="Enter"){
  writeln("");
  const cmd=INPUT;
  INPUT="";
  exec(cmd);
  writeln("");
  prompt();
 }
 else if(e.key.length===1){
  INPUT+=e.key;
  write(e.key);
 }
});

/* ================= UTILS ================= */
function delay(ms){ return new Promise(r=>setTimeout(r,ms)); }

/* ================= START ================= */
POST();
</script>
</body>
</html>
