<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>DOS Simulation Environment</title>
<style>
body {
  margin: 0;
  background: black;
  color: #00ff00;
  font-family: "Courier New", monospace;
}
#screen {
  padding: 10px;
  white-space: pre-wrap;
}
.bsob {
  color: #ffffff;
  background: #0000aa;
  padding: 10px;
}
</style>
</head>
<body>
<div id="screen"></div>

<script>
/* ============================================================
   CORE SYSTEM STATE
============================================================ */

const screen = document.getElementById("screen");

const CPU = {
  AX:0,BX:0,CX:0,DX:0,
  SI:0,DI:0,BP:0,SP:0,
  CS:0x1000, IP:0x0000,
  DS:0x2000, ES:0x2000, SS:0x3000,
  FLAGS:0,
  MODE:"real"
};

const MEMORY = {};
const PORTS = {};
const TSR = [];
let HALTED = false;

/* ============================================================
   FILESYSTEM
============================================================ */

const FS = {
  "C:": {
    type:"dir",
    children:{
      "CONFIG.SYS":{type:"file",content:"DEVICE=HIMEM.SYS\nDOS=HIGH"},
      "AUTOEXEC.BAT":{type:"file",content:"ECHO Booting DOS...\nTSR CLOCK\nCLS"},
      "COMMAND.COM":{type:"file",content:""}
    }
  }
};

let cwd = ["C:"];

/* ============================================================
   DISPLAY / OUTPUT
============================================================ */

function out(text="") {
  if (HALTED) return;
  screen.innerHTML += text + "\n";
  window.scrollTo(0,document.body.scrollHeight);
}

/* ============================================================
   INTERRUPTS
============================================================ */

const Interrupts = {
  0x10: biosVideo,
  0x16: biosKeyboard,
  0x21: dosServices
};

function INT(num) {
  if (HALTED) return;
  TSR.forEach(t => t(num,CPU));
  Interrupts[num]?.(CPU);
}

/* ============================================================
   BIOS
============================================================ */

function biosVideo(cpu) {
  const ah = cpu.AX >> 8;
  if (ah === 0x0E) {
    screen.innerHTML += String.fromCharCode(cpu.AX & 0xFF);
  }
}

function biosKeyboard(cpu) {
  cpu.AX = 0;
}

/* ============================================================
   DOS SERVICES
============================================================ */

function dosServices(cpu) {
  const ah = cpu.AX >> 8;

  switch(ah) {
    case 0x09:
      out(cpu.DX);
      break;

    case 0x4C:
      out("\nProgram terminated.");
      break;

    default:
      crash("Unhandled INT 21h AH=" + ah.toString(16));
  }
}

/* ============================================================
   TSR SYSTEM
============================================================ */

function loadTSR(name) {
  if (name === "CLOCK") {
    TSR.push((intNum,cpu)=>{
      if (intNum === 0x1C) {
        out("[TSR CLOCK] Tick " + new Date().toLocaleTimeString());
      }
    });
    out("TSR CLOCK loaded resident.");
  }
}

/* ============================================================
   CONFIG.SYS / AUTOEXEC.BAT
============================================================ */

function parseConfig() {
  const cfg = FS["C:"].children["CONFIG.SYS"].content.split("\n");
  cfg.forEach(line=>{
    if (line.startsWith("DEVICE=")) {
      out("Loading device driver " + line.split("=")[1]);
    }
    if (line.startsWith("DOS=HIGH")) {
      CPU.MODE="protected";
      out("DOS moved to high memory.");
    }
  });
}

function runAutoexec() {
  const bat = FS["C:"].children["AUTOEXEC.BAT"].content.split("\n");
  bat.forEach(cmd=>execute(cmd));
}

/* ============================================================
   HARDWARE PORT I/O
============================================================ */

function OUT(port,value) {
  PORTS[port]=value;
}

function IN(port) {
  return PORTS[port] || 0;
}

/* ============================================================
   COMMAND EXECUTION
============================================================ */

function execute(cmd) {
  const parts = cmd.trim().split(" ");
  const c = parts[0]?.toUpperCase();

  if (!c) return;

  switch(c) {
    case "ECHO":
      out(parts.slice(1).join(" "));
      break;

    case "CLS":
      screen.innerHTML="";
      break;

    case "TSR":
      loadTSR(parts[1]);
      break;

    case "CRASH":
      crash("Manual crash invoked.");
      break;

    case "PROT":
      if (CPU.MODE !== "protected")
        protFault();
      else
        out("Protected-mode call OK.");
      break;

    default:
      out("Bad command or file name");
  }
}

/* ============================================================
   PROTECTED MODE FAULT
============================================================ */

function protFault() {
  crash("General Protection Fault\nCS:IP="+hex(CPU.CS)+":"+hex(CPU.IP));
}

/* ============================================================
   BSOD / HALT
============================================================ */

function crash(reason) {
  HALTED = true;
  screen.innerHTML = `
<div class="bsob">
A problem has been detected and DOS has been shut down.

${reason}

CS:${hex(CPU.CS)} IP:${hex(CPU.IP)}
DS:${hex(CPU.DS)} ES:${hex(CPU.ES)}

Press Reset to restart your computer.
</div>`;
}

/* ============================================================
   UTIL
============================================================ */

function hex(v){return "0x"+v.toString(16).toUpperCase();}

/* ============================================================
   BOOT SEQUENCE
============================================================ */

out("Starting MS-DOS...");
parseConfig();
runAutoexec();
out("\nC:\\>");

</script>
</body>
</html>
