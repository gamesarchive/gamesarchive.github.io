<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>MS-DOS</title>
<style>
*{user-select:none}
body{
 margin:0;background:black;color:#fff;
 font-family:"Courier New",monospace;font-size:16px
}
#screen{padding:10px;white-space:pre-wrap}
.bsod{background:#0000aa;color:white;padding:12px}
</style>
</head>

<body tabindex="0">
<div id="screen"></div>

<script>
/* ================= IMMERSION ================= */
document.body.focus();
document.addEventListener("contextmenu",e=>e.preventDefault());
document.body.addEventListener("blur",()=>document.body.focus());

/* ================= SYSTEM STATE ================= */
const screen=document.getElementById("screen");
let HALTED=false,READY=false,INPUT="";
let CMOS_OK=Math.random()>0.2;

const CPU={
 CS:0x1000,IP:0,DS:0x2000,ES:0x2000,
 MODE:"real",RAM:{conv:640,upper:384,high:0},
};

let BOOT_ORDER=["A:","C:"];

/* ================= FILE SYSTEM ================= */
let FS={
 "A:":{bootable:false,type:"dir",children:{}},
 "C:":{bootable:true,type:"dir",children:{
  "CONFIG.SYS":{type:"file",content:"DOS=HIGH"},
  "AUTOEXEC.BAT":{type:"file",content:"ECHO Booting MS-DOS...\nCLS"},
  "COMMAND.COM":{type:"file",content:""}
 }}
};

let cwd=["C:"];

function getDir(p=cwd){
 let n=FS; for(const x of p) n=n[x].children; return n;
}

/* ================= OUTPUT ================= */
function out(t=""){
 if(HALTED) return;
 screen.innerHTML+=t+"\n";
 window.scrollTo(0,document.body.scrollHeight);
}

/* ================= POST ================= */
function POST(){
 screen.innerHTML="";
 out("PhoenixBIOS 4.0 Release 6.0");
 out("Copyright 1985-1998 Phoenix Technologies Ltd.");
 out("");
 if(!CMOS_OK){
  out("CMOS checksum error - Defaults loaded");
 }
 out("Checking RAM: "+CPU.RAM.conv+"K OK");
 out("Detecting Floppy Drive A: ... "+(FS["A:"].bootable?"OK":"None"));
 out("Detecting IDE Drive C: ... OK");
 out("");
 setTimeout(bootLoader,1200);
}

/* ================= BOOT LOADER ================= */
function bootLoader(){
 for(const dev of BOOT_ORDER){
  if(FS[dev]?.bootable){
   if(dev==="A:"&&!FS["A:"].children["IO.SYS"]){
    out("Non-System disk or disk error");
    out("Replace and press any key");
    READY=false; return;
   }
   bootDOS(dev);
   return;
  }
 }
 out("Missing operating system");
}

function bootDOS(dev){
 screen.innerHTML="";
 out("Starting MS-DOS...");
 runConfig();
 runAutoexec();
 prompt();
 READY=true;
}

/* ================= CONFIG / AUTOEXEC ================= */
function runConfig(){
 const cfg=FS["C:"].children["CONFIG.SYS"].content.split("\n");
 cfg.forEach(l=>{
  if(l==="DOS=HIGH"){CPU.MODE="protected";CPU.RAM.high=64;}
 });
}

function runAutoexec(){
 FS["C:"].children["AUTOEXEC.BAT"].content
 .split("\n").forEach(exec);
}

/* ================= COMMANDS ================= */
function exec(line){
 const a=line.trim().split(/\s+/);
 const c=a[0]?.toUpperCase();
 const dir=getDir();

 switch(c){
  case "DIR":
   out(" Directory of "+cwd.join("\\"));
   for(const k in dir)
    out((dir[k].type==="dir"?"<DIR> ":"      ")+k);
   break;

  case "MEM":
   out("Conventional Memory: "+CPU.RAM.conv+"K");
   out("Upper Memory: "+CPU.RAM.upper+"K");
   out("High Memory: "+CPU.RAM.high+"K");
   break;

  case "FORMAT":
   if(a[1]==="C:"){
    out("WARNING, ALL DATA ON NON-REMOVABLE DISK");
    out("DRIVE C: WILL BE LOST!");
    out("Proceed with Format (Y/N)?");
    HALTED=true;
    document.onkeydown=e=>{
     if(e.key.toUpperCase()==="Y"){
      FS["C:"].children={};
      HALTED=false;
      out("Formatting complete.");
      prompt();
     }
    };
    return;
   }
   break;

  case "FDISK":
   out("Fixed Disk Setup Program");
   out("No changes made.");
   break;

  case "SYS":
   if(a[1]==="C:"){
    FS["C:"].children["IO.SYS"]={type:"file",content:""};
    FS["C:"].children["MSDOS.SYS"]={type:"file",content:""};
    FS["C:"].bootable=true;
    out("System transferred.");
   }
   break;

  case "VER":
   out("MS-DOS Version 6.22");
   break;

  case "DATE":
   out(new Date().toLocaleDateString());
   break;

  case "TIME":
   out(new Date().toLocaleTimeString());
   break;

  case "CLS":
   screen.innerHTML=""; break;

  case "ECHO":
   out(a.slice(1).join(" ")); break;

  default:
   out("Bad command or file name");
 }
 prompt();
}

/* ================= INPUT ================= */
function prompt(){
 out(cwd.join("\\")+">"+INPUT);
}

document.addEventListener("keydown",e=>{
 if(!READY||HALTED) return;
 if(e.key==="Backspace"){
  INPUT=INPUT.slice(0,-1);
  screen.innerHTML=screen.innerHTML.slice(0,-1);
 }
 else if(e.key==="Enter"){
  out("");
  exec(INPUT);
  INPUT="";
 }
 else if(e.key.length===1){
  INPUT+=e.key;
  screen.innerHTML+=e.key;
 }
});

/* ================= START ================= */
POST();
</script>
</body>
</html>
